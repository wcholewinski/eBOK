{% extends "base.html" %}

{% block title %}ZarzƒÖdzanie sensorami - eBOK{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üîå ZarzƒÖdzanie sensorami i danymi eksploatacyjnymi</h2>
        <a href="{% url 'app:analytics_dashboard' %}" class="btn btn-outline-secondary">
            ‚Üê Powr√≥t do analityki
        </a>
    </div>

    <!-- Statystyki sensor√≥w -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary text-center h-100">
                <div class="card-body">
                    <h1 class="display-4 text-primary">{{ sensors_count }}</h1>
                    <h6 class="card-title">Aktywne sensory</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success text-center h-100">
                <div class="card-body">
                    <h1 class="display-4 text-success">{{ readings_today }}</h1>
                    <h6 class="card-title">Dzisiejsze odczyty</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning text-center h-100">
                <div class="card-body">
                    <h1 class="display-4 text-warning">{{ sensor_types|length }}</h1>
                    <h6 class="card-title">Typy sensor√≥w</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info text-center h-100">
                <div class="card-body">
                    <h1 class="display-4 text-info">{{ anomalies_count }}</h1>
                    <h6 class="card-title">Wykryte anomalie</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista sensor√≥w -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">üìù Lista sensor√≥w</h4>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSensorModal">
                ‚ûï Dodaj sensor
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Mieszkanie</th>
                            <th>Typ</th>
                            <th>Lokalizacja</th>
                            <th>Status</th>
                            <th>Ostatni odczyt</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sensor in sensors %}
                        <tr>
                            <td>{{ sensor.id }}</td>
                            <td>{{ sensor.apartment.number }}</td>
                            <td>{{ sensor.get_sensor_type_display }}</td>
                            <td>{{ sensor.location }}</td>
                            <td>
                                {% if sensor.is_active %}
                                <span class="badge bg-success">Aktywny</span>
                                {% else %}
                                <span class="badge bg-secondary">Nieaktywny</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if sensor.readings.exists %}
                                {{ sensor.readings.first.value }} {{ sensor.readings.first.unit }}
                                <small class="text-muted d-block">{{ sensor.readings.first.timestamp|date:"d.m.Y H:i" }}</small>
                                {% else %}
                                <span class="text-muted">Brak odczyt√≥w</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="#" class="btn btn-info" title="Szczeg√≥≈Çy">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="#" class="btn btn-warning" title="Edytuj">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button type="button" class="btn btn-success" title="Dodaj odczyt"
                                        data-bs-toggle="modal" data-bs-target="#addReadingModal"
                                        data-sensor-id="{{ sensor.id }}">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-3">
                                Nie znaleziono ≈ºadnych sensor√≥w w systemie.
                                <a href="#" data-bs-toggle="modal" data-bs-target="#addSensorModal">Dodaj pierwszy sensor</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ostatnie odczyty i anomalie -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">üìä Ostatnie odczyty</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Sensor</th>
                                    <th>Warto≈õƒá</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reading in recent_readings %}
                                <tr>
                                    <td>{{ reading.sensor.get_sensor_type_display }} (M. {{ reading.sensor.apartment.number }})</td>
                                    <td>{{ reading.value }} {{ reading.unit }}</td>
                                    <td>{{ reading.timestamp|date:"d.m.Y H:i" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center">Brak odczyt√≥w w systemie</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">‚ö†Ô∏è Wykryte anomalie</h5>
                </div>
                <div class="card-body">
                    {% if anomalies %}
                    <div class="list-group">
                        {% for anomaly in anomalies %}
                        <div class="list-group-item list-group-item-action list-group-item-warning">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Mieszkanie {{ anomaly.sensor.apartment.number }}</h6>
                                <small>{{ anomaly.timestamp|date:"d.m.Y H:i" }}</small>
                            </div>
                            <p class="mb-1">{{ anomaly.sensor.get_sensor_type_display }}: {{ anomaly.value }} {{ anomaly.unit }}</p>
                            <small>Odchylenie od normy: {{ anomaly.deviation|default:"nieznane" }}%</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <p class="mb-0">Nie wykryto ≈ºadnych anomalii w ostatnich odczytach.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Importowanie danych -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h4 class="mb-0">üì• Import danych z pliku</h4>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" action="{% url 'app:import_utility_consumption' %}">
                {% csrf_token %}
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="csv_file" class="form-label">Plik CSV z danymi zu≈ºycia</label>
                            <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="utility_type" class="form-label">Rodzaj medium</label>
                            <select class="form-select" id="utility_type" name="utility_type">
                                <option value="electricity">PrƒÖd</option>
                                <option value="water">Woda</option>
                                <option value="gas">Gaz</option>
                                <option value="heating">Ogrzewanie</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Importuj dane</button>
                        </div>
                    </div>
                </div>
                <small class="text-muted">Format pliku: apartment_number,month,consumption,unit (np. 101,2023-01,250.5,kWh)</small>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Dodawanie sensora -->
<div class="modal fade" id="addSensorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj nowy sensor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'app:add_sensor' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="apartment" class="form-label">Mieszkanie</label>
                        <select class="form-select" id="apartment" name="apartment">
                            {% for apt in apartments %}
                            <option value="{{ apt.id }}">Mieszkanie {{ apt.number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sensor_type" class="form-label">Typ sensora</label>
                        <select class="form-select" id="sensor_type" name="sensor_type">
                            {% for type_code, type_name in sensor_types %}
                            <option value="{{ type_code }}">{{ type_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Lokalizacja w mieszkaniu</label>
                        <input type="text" class="form-control" id="location" name="location" required>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">Sensor aktywny</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Dodaj sensor</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Dodawanie odczytu -->
<div class="modal fade" id="addReadingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj nowy odczyt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'app:add_sensor_reading' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="sensor_id" name="sensor_id" value="">
                    <div class="mb-3">
                        <label for="value" class="form-label">Warto≈õƒá odczytu</label>
                        <input type="number" step="0.01" class="form-control" id="value" name="value" required>
                    </div>
                    <div class="mb-3">
                        <label for="unit" class="form-label">Jednostka</label>
                        <select class="form-select" id="unit" name="unit">
                            <option value="kWh">kWh (prƒÖd)</option>
                            <option value="m¬≥">m¬≥ (woda, gaz)</option>
                            <option value="¬∞C">¬∞C (temperatura)</option>
                            <option value="%">% (wilgotno≈õƒá)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz odczyt</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Obs≈Çuga modala dodawania odczytu
    var addReadingModal = document.getElementById('addReadingModal')
    if (addReadingModal) {
        addReadingModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget
            var sensorId = button.getAttribute('data-sensor-id')
            var sensorIdInput = addReadingModal.querySelector('#sensor_id')
            sensorIdInput.value = sensorId
        })
    }
</script>
{% endblock %}
